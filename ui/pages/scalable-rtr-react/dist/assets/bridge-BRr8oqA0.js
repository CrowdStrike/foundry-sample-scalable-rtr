var V=Object.defineProperty;var Q=(o,e,t)=>e in o?V(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var y=(o,e,t)=>Q(o,typeof e!="symbol"?e+"":e,t);import{o as i,u as l,b as E,s as n,n as M,a as R,c as d,l as r,d as m,D as C,B}from"./index-CNBs9zUP.js";const A=[{id:"abc123",name:"Mitre hosts"},{id:"def456",name:"RTR hosts"},{id:"ghi789",name:"Response hosts"}],U=[{name:"groups",buckets:[{label:"abc123",count:42},{label:"def456",count:23}]}],v=[{device_id:"xyz987",hostname:"Odysseus"},{device_id:"mno654",hostname:"Agamemnon"},{device_id:"pqr321",hostname:"Achilles"}],L=[{uuid:"uuid1",cid:"cid",uid:"f.bird@crowdstrike.com",first_name:"Falcon",last_name:"Bird",created_at:"2023-09-12T14:35:46Z"},{uuid:"uuid2",cid:"cid",uid:"p.bird@crowdstrike.com",first_name:"Peregrine",last_name:"Bird",created_at:"2023-09-12T14:35:46Z"},{uuid:"uuid3",cid:"cid",uid:"r.dino@crowdstrike.com",first_name:"Raptor",last_name:"Dino",created_at:"2023-09-12T14:35:46Z"}],K={id:"1",draft:!0,version:0,user_id:"dummy",user_name:"dummy",name:"First Job RTR",description:"First Job RTR",notification_emails:null,notifications:null,tags:null,host_count:A.length,run_count:0,total_recurrences:0,action:{type:"buildQuery",query_type:"file",query_file_paths:["azerty","qwerty"]},schedule:{time_cycle:"5 4 * * *",start_date:"2023-08-31T04:05",end_date:"2023-09-02T23:59"},target:{host_groups:A.map(o=>o.id),hosts:null,offline_queueing:!0},run_now:!1,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},z={id:"2",draft:!1,version:0,user_id:"dummy",user_name:"dummy",name:"Second Job RTR",description:"Second Job RTR",notification_emails:null,notifications:null,tags:null,host_count:v.length,run_count:0,total_recurrences:3,action:{type:"buildQuery",query_type:"registryKey",registry_keys:[{key:"hello",value:"world"}]},schedule:{time_cycle:"5 4 * * *",start_date:"2023-08-31T04:05",end_date:"2023-09-02T23:59"},target:{host_groups:null,hosts:v.map(o=>o.device_id),offline_queueing:!0},run_now:!1,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},W={id:"3",draft:!1,version:0,user_id:"dummy",user_name:"dummy",name:"Third Job RTR",description:"Third Job RTR",notification_emails:null,notifications:null,tags:null,host_count:v.length,run_count:0,total_recurrences:90,action:{type:"buildQuery",query_type:"registryKey",registry_keys:[{key:"hello",value:"world"}]},schedule:{time_cycle:"5 4 * * *",start_date:"2023-08-31T04:05",end_date:"2023-09-02T23:59"},target:{host_groups:null,hosts:v.map(o=>o.device_id),offline_queueing:!0},run_now:!1,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},X={id:"4",draft:!1,version:0,user_id:"dummy",user_name:"dummy",name:"Fourth Job RTR",description:"Fourth Job RTR",notification_emails:null,notifications:null,tags:null,host_count:v.length,run_count:0,total_recurrences:0,action:{type:"buildQuery",query_type:"registryKey",registry_keys:[{key:"hello",value:"world"}]},schedule:{time_cycle:"5 4 * * *",start_date:"2023-08-31T04:05",end_date:"2023-09-02T23:59"},target:{host_groups:null,hosts:v.map(o=>o.device_id),offline_queueing:!0},run_now:!1,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},Y={id:"5",draft:!1,version:0,user_id:"dummy",user_name:"dummy",name:"Fifth Job RTR",description:"Fifth Job RTR",notification_emails:null,notifications:null,tags:null,host_count:v.length,run_count:0,total_recurrences:0,action:{type:"buildQuery",query_type:"registryKey",registry_keys:[{key:"hello",value:"world"}]},schedule:{time_cycle:"5 4 * * *",start_date:"2023-08-31T04:05",end_date:"2023-09-02T23:59"},target:{host_groups:null,hosts:v.map(o=>o.device_id),offline_queueing:!0},run_now:!1,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},O={id:"6",draft:!1,version:0,user_id:"dummy",user_name:"dummy",name:"Sixth Job RTR",description:"Sixth Job RTR",notification_emails:null,notifications:null,tags:null,host_count:v.length,run_count:0,total_recurrences:0,action:{type:"buildQuery",query_type:"registryKey",registry_keys:[{key:"hello",value:"world"}]},schedule:{time_cycle:"5 4 * * *",start_date:"2023-08-31T04:05",end_date:"2023-09-02T23:59"},target:{host_groups:null,hosts:v.map(o=>o.device_id),offline_queueing:!0},run_now:!1,next_run:"2023-08-31T08:25:17.179Z",last_run:"2023-08-31T08:25:17.179Z",created_at:"2023-08-31T08:25:17.179Z",updated_at:"2023-08-31T08:25:17.179Z",deleted_at:"2023-08-31T08:25:17.179Z"},ee={id:"1",job_id:"1",execution_id:"1",name:"First Job RR",run_date:"2023-08-11 09:35:29",duration:"00:12:21",status:"completed",hosts:["host1"],numHosts:1,receivedFiles:2,endDate:"2023-08-09 13:42:34"},te={id:"2",job_id:"2",execution_id:"2",name:"CVE-2023-123457",run_date:"2023-08-08 13:42:34",duration:"00:02:47",status:"completed",hosts:["host1","host2"],numHosts:2,receivedFiles:2,endDate:"2023-08-09 13:42:34"},oe={id:"1",job_id:"1",job_name:"CVE-2023-123456",modified_at:"2023-08-11 09:35:29",version:1,modified_by:"g.thegrey@crowdstrike.com",action:"Created JobRTR"},ne={id:"2",job_id:"2",job_name:"CVE-2023-123457",modified_at:"2023-08-11 09:35:29",version:1,modified_by:"a.elessar@crowdstrike.com",action:"Created JobRTR"};function k(o){return o.type==="api"}function se(o){return k(o)&&o.api==="faasGateway"}function ie(o){return k(o)&&o.api==="devices"}function re(o){return k(o)&&o.api==="userManagement"}class ae{isMatch(e){return ie(e)&&(e.method==="postAggregatesDevicesGetV1"||e.method==="getEntitiesGroupsV1"||e.method==="postEntitiesDevicesV2"||e.method==="getQueriesDevicesV2")}async responder(e){let t={};if(e.method==="postAggregatesDevicesGetV1")t={errors:[],resources:U};else if(e.method==="getEntitiesGroupsV1")t={errors:[],resources:A};else if(e.method==="getQueriesDevicesV2"){const s=v.map(a=>a.device_id);t={errors:[],resources:s}}else e.method==="postEntitiesDevicesV2"&&(t={errors:[],resources:v});return Promise.resolve(t)}}class de{isMatch(e){return re(e)&&(e.method==="postEntitiesUsersGetV1"||e.method==="getQueriesUsersV1")}async responder(e){let t={};return e.method==="postEntitiesUsersGetV1"?t={errors:[],resources:L}:e.method==="getQueriesUsersV1"&&(t={errors:[],resources:L.map(s=>s.uuid)}),Promise.resolve(t)}}const H=i({type:r("buildQuery"),query_type:r("file"),query_file_paths:d(n())}),N=i({type:r("buildQuery"),query_type:r("registryKey"),registry_keys:d(i({key:n(),value:n()}))});i({user_id:n(),user_name:n(),version:M(),id:n(),name:n(),description:n(),notification_emails:l([R(),d(n())]).optional(),notifications:l([R(),d(n())]),draft:E(),tags:l([R(),d(n())]),host_count:M(),run_count:M(),total_recurrences:M(),action:l([H,N]),schedule:l([i({time_cycle:n().nullable().optional().default(null),start_date:n(),end_date:n().nullable().optional().default(null)}),R()]),target:i({host_groups:l([R(),d(n())]),hosts:l([R(),d(n())]),offline_queueing:E()}),run_now:E(),next_run:n(),last_run:n(),created_at:n(),updated_at:n(),deleted_at:n()});const ue=i({user_id:n(),user_name:n(),version:M(),name:n(),description:n(),notifications:l([R(),d(n())]),tags:l([R(),d(n())]),action:l([H,N]),run_now:E(),schedule:l([i({time_cycle:n().nullable().optional().default(null),start_date:n(),end_date:n().nullable().optional().default(null)}),R()]),target:i({host_groups:l([R(),d(n())]),hosts:l([R(),d(n())]),offline_queueing:E()})}),ce=i({method:n(),payload:i({body:i({function_id:n().optional(),function_name:n().optional(),payload:i({path:n()})})})}),le=i({function_id:n().optional(),function_name:n().optional(),function_version:M(),payload:i({params:i({query:i({draft:d(l([r("true"),r("false")]))}).optional()}).optional(),body:ue})}),pe=i({payload:i({body:i({payload:i({params:i({query:i({fieldName:l([r("name"),r("description"),r("last_run_date"),r("next_run_date"),r("hosts"),r("last_modified"),r("draft")]).optional(),direction:l([r("ASC"),r("DESC")]).optional(),limit:l([d(r("5")),d(r("10")),d(r("15")),d(r("20"))]).optional(),offset:d(n()).optional(),prev:d(n()).optional(),next:d(n()).optional()}).optional()}).optional()})})})}),_e=i({payload:i({body:i({payload:i({params:i({query:i({id:d(n())})})})})})}),F=":";class D{constructor({db:e,appName:t}){y(this,"functionId","mock-faas-function");y(this,"functionName","mock-faas-function-name");y(this,"requestPath","/mock-path");y(this,"counter",0);y(this,"bus",{});y(this,"db");y(this,"appName");this.db=e,this.appName=t}isMatch(e){return se(e)&&(this.isPost(e)||this.isGet(e))}isPost(e){const t=ce.safeParse(e);if(!t.success)return!1;const{method:s}=t.data,{function_id:a,function_name:u}=t.data.payload.body,{path:c}=t.data.payload.body.payload;return s==="postEntitiesExecutionV1"&&(a===this.functionId||u===this.functionName)&&c===this.requestPath}isGet(e){const{id:t}=e.payload.params;if(typeof t!="string")return!1;const[s,a,u,c]=t.split(F);return e.method==="getEntitiesExecutionV1"&&(s===this.functionId||a===this.functionName)&&u===this.requestPath}prepareResponse(e){return{errors:[],resources:[]}}async responder(e){if(this.isPost(e)){const t=[this.functionId,this.functionName,this.requestPath,++this.counter].join(F);return this.bus[t]=this.prepareResponse(e),Promise.resolve({resources:[{execution_id:t,function_id:this.functionId}]})}else if(this.isGet(e)){const{id:t}=e.payload.params;if(!t||typeof t!="string")throw"No id supplied";if(!this.bus[t])throw`No response for id: ${t}`;return Promise.resolve(this.bus[t])}}}class fe extends D{constructor(e){super(e),this.functionId=m.createJob.id,this.functionName=m.createJob.name,this.requestPath=m.createJob.path}prepareResponse(e){var a,u;if(!("body"in e.payload))throw`CreateJobHandler received bad message: ${e.toString()}`;const s=le.safeParse(e.payload.body);if(s.success){const c=this.db.jobs.findIndex(h=>h.name===s.data.payload.body.name);if(c>-1&&this.db.jobs[c].draft===!1)return{resources:[{function_id:this.functionId,function_name:this.functionName,function_version:1,payload:{body:null,errors:[{field:"jobName",message:`Job name "${s.data.payload.body.name}" already exists"`,code:102}],status_code:400}}]};const[f]=((u=(a=s.data.payload.params)==null?void 0:a.query)==null?void 0:u.draft)??["false"],{version:p,...g}=s.data.payload.body,x={id:c>-1?this.db.jobs[c].id:(Math.random()+1).toString(36).substring(7),version:p+1,draft:f==="true",total_recurrences:0,run_count:0,host_count:0,next_run:"2023-12-01T12:00",last_run:"",created_at:"2023-12-01T12:00",updated_at:"2023-12-01T12:00",deleted_at:"",notification_emails:g.notifications,...g};return c===-1?this.db.jobs.unshift(x):c>-1&&this.db.jobs[c].draft===!0&&(this.db.jobs[c]=x),{errors:[],resources:[{function_id:this.functionId,function_name:this.functionName,function_version:1,payload:{body:{resource:"a_random_uid"},errors:[],status_code:200}}]}}else return{resources:[{function_id:this.functionId,function_name:this.functionName,function_version:1,payload:{body:null,errors:s.error.issues.map(c=>({message:c.message})),status_code:400}}]}}}i({job_name:n(),modified_at:n(),version:M(),modified_by:n(),action:n(),id:n(),job_id:n()});const he=i({payload:i({body:i({payload:i({params:i({query:i({fieldName:l([r("name"),r("date_modified"),r("version"),r("modified_by"),r("action_taken")]).optional(),direction:l([r("ASC"),r("DESC")]).optional(),limit:l([d(r("5")),d(r("10")),d(r("15")),d(r("20"))]).optional(),offset:d(n()).optional(),prev:d(n()).optional(),next:d(n()).optional(),page:M().optional(),id:d(n()).optional(),filter:d(n()).optional()}).optional()}).optional()})})})}),S=10;function ye(o,e,t){const s=Math.ceil((t+1)/e);return t===-1?{paginatedJobs:o,page:s}:{paginatedJobs:o.slice(t,t+(e+1)),page:s}}function me(o,e,t,s,a){var h,b,T;let u=o.findIndex(_=>_.id===t);a!==""?u=o.findIndex(_=>_.id===a):s!==""&&(u=o.findIndex(_=>_.id===s));const{paginatedJobs:c,page:f}=ye(o,e,u),p=(h=o[u-e])!=null&&h.id?`${(b=o[u-e])==null?void 0:b.id}:${f-1}`:"",g=o.slice(-1),J=c.length===e+1?`${(T=g[0])==null?void 0:T.id}:${f}`:"";return{currentPage:e?c.slice(0,e):c,prevCursor:p,nextCursor:J}}class ge extends D{constructor(e){super(e),this.functionId=m.getAuditLog.id,this.functionName=m.getAuditLog.name,this.requestPath=m.getAuditLog.path}prepareResponse(e){var w,I,P,Z;const{logs:t}=this.db,a=((w=he.parse(e).payload.body.payload.params)==null?void 0:w.query)??{},{offset:u=null,limit:c=[String(S)],prev:f=null,next:p=null}=a,g=(u==null?void 0:u[0])??"",J=((I=f==null?void 0:f[0].split(":"))==null?void 0:I[0])??"",x=((P=p==null?void 0:p[0].split(":"))==null?void 0:P[0])??"",h=parseInt(c[0])??S;let b=t;if(a&&a.filter&&a.filter.length>0){const[Pe,$]=a.filter[0].split(":");b=t.filter(G=>$.includes(G.job_id))}const{prevCursor:T,nextCursor:_,currentPage:q}=me(b,h,g,J,x);return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resources:b,meta:{total:t.length,limit:h,offset:((Z=q[0])==null?void 0:Z.id)||"",count:q.length,prev:T,next:_}}}}]}}}class be extends D{constructor(e){super(e),this.functionId=m.getJobDetails.id,this.functionName=m.getJobDetails.name,this.requestPath=m.getJobDetails.path}prepareResponse(e){const{jobs:t}=this.db,a=_e.parse(e).payload.body.payload.params.query??{},u=t.find(c=>a.id.includes(c.id));return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resource:u}}}]}}}function Te(o,e,t){const s=Math.ceil((t+1)/e);return t===-1?{paginatedJobs:o,page:s}:{paginatedJobs:o.slice(t,t+(e+1)),page:s}}function ve(o,e,t,s,a){var h,b,T;let u=o.findIndex(_=>_.id===t);a!==""?u=o.findIndex(_=>_.id===a):s!==""&&(u=o.findIndex(_=>_.id===s));const{paginatedJobs:c,page:f}=Te(o,e,u),p=(h=o[u-e])!=null&&h.id?`${(b=o[u-e])==null?void 0:b.id}:${f-1}`:"",g=o.slice(-1),J=c.length===e+1?`${(T=g[0])==null?void 0:T.id}:${f}`:"";return{currentPage:e?c.slice(0,e):c,prevCursor:p,nextCursor:J}}class Re extends D{constructor(e){super(e),this.functionId=m.getJobs.id,this.functionName=m.getJobs.name,this.requestPath=m.getJobs.path}prepareResponse(e){var w,I,P,Z;const{jobs:t}=this.db,a=((w=pe.parse(e).payload.body.payload.params)==null?void 0:w.query)??{},{offset:u=null,limit:c=[String(C)],prev:f=null,next:p=null}=a,g=(u==null?void 0:u[0])??"",J=((I=f==null?void 0:f[0].split(":"))==null?void 0:I[0])??"",x=((P=p==null?void 0:p[0].split(":"))==null?void 0:P[0])??"",h=parseInt(c[0])??C,b=t,{prevCursor:T,nextCursor:_,currentPage:q}=ve(b,h,g,J,x);return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resources:q,meta:{total:t.length,limit:h,offset:((Z=q[0])==null?void 0:Z.id)||"",count:q.length,prev:T,next:_}}}}]}}}i({id:n(),job_id:n(),execution_id:n(),name:n(),duration:n(),hosts:d(n()),numHosts:M(),receivedFiles:M(),run_date:n(),endDate:n(),status:n()});const Je=i({payload:i({body:i({payload:i({params:i({query:i({fieldName:l([r("name"),r("run_date"),r("status"),r("duration"),r("hosts")]).optional(),direction:l([r("ASC"),r("DESC")]).optional(),limit:l([d(r("5")),d(r("10")),d(r("15")),d(r("20"))]).optional(),offset:d(n()).optional(),prev:d(n()).optional(),next:d(n()).optional(),id:d(n()).optional(),filter:d(n()).optional(),exact_name:d(n()).optional()}).optional()}).optional()})})})}),j=10;function xe(o,e,t){var a;const s=o.findIndex(u=>u.id===t);return((a=o[s-e])==null?void 0:a.job_id)||""}function qe(o,e,t){const s=o.findIndex(a=>a.id===t);return s===-1?o:o.slice(s,s+(e+1))}function Me(o,e,t){var p;const s=qe(o,e,t),a=xe(o,e,t),u=o.slice(-1),c=s.length===e+1?(p=u[0])==null?void 0:p.id:"";return{currentPage:e?s.slice(0,e):s,prevCursor:a,nextCursor:c}}class we extends D{constructor(e){super(e),this.functionId=m.getRunHistory.id,this.functionName=m.getRunHistory.name,this.requestPath=m.getRunHistory.path}prepareResponse(e){var b;const{history:t}=this.db,a=((b=Je.parse(e).payload.body.payload.params)==null?void 0:b.query)??{},{offset:u=null,limit:c=[String(j)]}=a,f=(u==null?void 0:u[0])??"",p=parseInt(c[0])??j;let g=t;if(a&&a.filter&&a.filter.length>0){const T=a.filter[0].split(":")[0],_=a.filter[0].split(":")[1];g=t.filter(q=>{var w,I;if(T==="job_name"&&(((w=a.exact_name)==null?void 0:w.length)??!1))return((I=a.exact_name)==null?void 0:I[0])==="true"?_===q.name:_.includes(q.name);if(T==="job_id")return q.job_id===_})}const{prevCursor:J,nextCursor:x,currentPage:h}=Me(g,p,f);return{errors:[],resources:[{function_id:this.functionId,function_version:1,payload:{body:{resources:h,meta:{total:g.length,limit:p,count:h.length,prev:J,next:x}}}}]}}}const Ie={jobs:[],history:[],logs:[]},De={jobs:[K,z,W,X,Y,O],history:[ee,te],logs:[oe,ne]};class Ae extends B{constructor({db:t,appName:s}={db:Ie,appName:"rapid-response"}){super();y(this,"createJob");y(this,"getJobs");y(this,"getJobDetails");y(this,"getAuditLog");y(this,"getRunHistory");y(this,"devices");y(this,"userManagement");y(this,"db");this.db=t,this.createJob=new fe({db:this.db,appName:s}),this.getJobs=new Re({db:this.db,appName:s}),this.getJobDetails=new be({db:this.db,appName:s}),this.getAuditLog=new ge({db:this.db,appName:s}),this.getRunHistory=new we({db:this.db,appName:s}),this.devices=new ae,this.userManagement=new de}async postMessage(t){let s;if(this.devices.isMatch(t)?s=await this.devices.responder(t):this.userManagement.isMatch(t)?s=await this.userManagement.responder(t):this.getJobs.isMatch(t)?s=await this.getJobs.responder(t):this.createJob.isMatch(t)?s=await this.createJob.responder(t):this.getJobDetails.isMatch(t)?s=await this.getJobDetails.responder(t):this.getAuditLog.isMatch(t)?s=await this.getAuditLog.responder(t):this.getRunHistory.isMatch(t)?s=await this.getRunHistory.responder(t):s=await super.postMessage(t),!s)throw new Error("Woops!");return console.log("MockBridge#postMessage: ",{message:t,value:s}),s}}export{Ae as MockBridge,Ie as emptyScenario,De as populatedScenario};
